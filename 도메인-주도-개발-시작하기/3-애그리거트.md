## 애그리거트

관련된 도메인을 묶은 하나의 군

### 왜 필요한가?

- 상위 수준에서 모델을 정리하면 도메인 모델의 `복잡한 관계를 이해` 하는 데 도움이 된다. <br>
  → 코드를 변경하고 확장하는 것이 수월해진다.

- `일관성` 을 관리하는 기준이 된다.

### 특징

- 독립된 객체 군으로, 한 애그리거트에 속한 객체는 다른 애그리거트에 속하지 않는다.

- 도메인 규칙과 요구사항으로 애그리거트 간 `경계`를 설정한다. <br>
  - 라이프사이클
  - 객체를 변경하는 주체

<br>

### 애그리거트 루트

애그리거트 전체를 관리하는 주체이자 대표 엔티티이다. <br>
`애그리거트의 일관성` 이 깨지지 않도록 한다.

#### 일관성을 관리하는 방법

1. setter를 공개(public) 범위로 만들지 않는다. <br>
  → 도메인 로직을 응용 또는 표현 영역으로 분산시켜 `도메인 로직의 응집성` 을 떨어트린다.
2. 밸류 타입은 불변으로 구현한다. <br>
  → 애그리거트 외부에서 밸류 객체의 상태를 변경하는 것을 막아 `일관성` 을 유지한다.

<br>

### 트랜잭션

- 하나의 트랜잭션에서는 하나의 애그리거트만 수정해야 한다. <br>
  트랜잭션 충돌을 막아 처리량을 높이기 위해서이다.
- `도메인 이벤트` 를 사용해 한 트랜잭션에서 한 개의 애그리거트를 수정하면서도 다른 애그리거트의 상태를 변경하는 코드를 작성할 수 있다.

<br>

### 레포지토리

객체의 영속성을 처리하는 레포지토리는 `애그리거트 단위` 로 존재한다.

#### 객체 참조(직접 참조)의 문제점

- 편한 탐색 오용 <br>
  : 참조한 객체를 통해 다른 애그리거트의 상태를 쉽게 변경할 수 있게 된다.
  
- 성능에 대한 고민 <br>
  : 지연(lazy)로딩과 즉시(eager)로딩 등을 고민해야 한다.
  
- 확장 어려움 <br>
  : 데이터베이스 저장소가 다양해지면 다른 애그리거트를 참조할 때 JPA 등의 단일 기술을 사용할 수 없게 된다.

#### ID 참조(간접 참조)의 장점

- 복잡도 감소 <br>
  : 애그리거트의 경계를 명확히 하고 애그리거트 간 물리적 연결을 제거한다.

- 응집도 증가 <br>
  : 애그리거트 간 의존을 제거한다.

#### ID 참조 시 문제점

참조하는 여러 애그리거트를 읽을 때 `N+1 문제` 로 조회 속도에 문제가 발생할 수 있다. <br>
→ `조회 전용 쿼리` 를 사용한다.

```java
public class OrderViewRepository {

  public List<OrderView> findById(Long id) {
    String query = "select new OrderView(order, memeber, product) from Order ... ";
    // 생략
}
```

→ 애그리거트마다 서로 다른 저장소를 사용하는 경우, `캐시` 를 적용하거나 `조회 전용 저장소` 를 따로 구성한다.

<br>

### 애그리거트 팩토리

```java
public class StoreService {

  public void registerNewProduct() {
    Store store = storeRepository.findById();

    // 도메인 로직
    if (store.isBlocked()) {
      throw new Exception();
    }

    // Product 생성 로직
    Product product = new Product();
}
```

하나의 애그리거트를 생성하는 과정에서 도메인 로직이 포함될 경우 다른 애그리거트가 `팩토리 역할` 을 할 수 있다.

```java
public class Store {

  public Product createProduct() {
    if (isBlocked()) {
      throw new Exception();
    }

    return new Product();
  }
}
```

#### 장점

- 도메인 로직이 변경되어도 응용 서비스는 영향을 받지 않는다.
- 도메인의 `응집도` 가 높아진다.
  
