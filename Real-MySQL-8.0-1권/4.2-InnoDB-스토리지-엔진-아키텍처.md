## InnoDB의 특징

- MySQL의 스토리지 엔진 가운데 가장 많이 사용된다.
  
- 거의 유일하게 `레코드 기반의 잠금`을 제공한다. <br>
  → 높은 동시성 처리가 가능하고 안정적이며 성능이 뛰어나다.

<br>

### 프라이머리 키에 의한 클러스터링

- 기본적으로 프라이머리 키 값의 순서대로 디스크에 저장된다. <br>
→ 프라이머리 키를 이용한 레인지 스캔은 상당히 빨리 처리될 수 있다.

- 모든 세컨더리 인덱스는 레코드의 주소 대신 프라이머리 키의 값을 논리적 주소로 사용한다.

<br>

### 외래 키 지원

- 데이터베이스 서버 운영의 불편함 때문에 서비스용 데이터베이스에서는 생성하지 않는 경우도 많다.

- 외래 키 생성 시, 부모 테이블과 자식 테이블 모두 해당 칼럼에 인덱스 생성이 필요하다.
  
- 외래 키 변경 시에는 반드시 부모 테이블이나 자식 테이블에 데이터가 있는지 체크하는 작업이 필요하다. <br>
  → `잠금이 여러 테이블로 전파`되기 때문에 데드락이 발생할 때가 많다.

- `foreign_key_checks` 시스템 변수로 외래 키 관계에 대한 체크 작업을 조절할 수 있다. <br>
  또한 해당 변수가 비활성화되면 부모 테이블에 대한 작업(`ON DELETE CASECADE, ON UPDATE CASCADE` 옵션)도 무시하게 된다.

<br>

### MVCC(Multi Version Concurrency Control)

- 일반적으로 레코드 레벨의 트랜잭션을 지원하는 DBMS가 제공하는 기능이다. <br>

- 가장 큰 목적은 `잠금을 사용하지 않는 일관된 읽기`를 제공하는 데 있다.

- InnoDB는 `언두 로그(Undo Log)`를 이용해 이 기능을 구현한다. <br>
  격리 수준에 따라 `READ_UNCOMMITTED`인 경우에는 버퍼 풀의 데이터를, 그 이상의 격리 수준인 경우에는 언두 영역의 데이터를 반환한다.
  
- 트랜잭션이 롤백되면 언두 영역에 있는 백업된 데이터를 버퍼 풀로 다시 복구하고, 언두 영역의 내용을 삭제한다. <br>
  트랜잭션이 커밋될 경우 다른 변화는 없고, 해당 언두 로그를 필요로 하는 트랜잭션이 더는 없을 때 언두 로그가 삭제된다.

<br>

### 잠금 없는 일관된 읽기(Non-Locking Consistent Read)

- MVCC를 이용해 잠금을 걸지 않고 읽기 작업을 수행한다. <br>
  다만 격리 수준이 `SERIALIZABLE`인 경우 읽기 작업 때도 공유 잠금(읽기 잠금)을 획득해야 한다.

<br>

### 자동 데드락 감지

- InnoDB는 데드락을 체크하기 위해 `잠금 대기 목록`을 그래프(Wait-for List) 형태로 관리한다.

- 데드락 감지 스레드가 주기적으로 잠금 대기 그래프를 검사해 교착 상태에 빠진 트랜잭션 중 하나를 강제 종료한다. <br>
  이 때 언두 로그 레코드를 가장 적게 가진 트랜잭션이 일반적으로 롤백의 대상이 된다.

- 데드락 감지 스레드는 잠금 목록이 저장된 리스트(잠금 테이블)에 새로운 잠금을 걸고 데드락 스레드를 찾는다. <br>
 
- `innodb_deadlock_detect` 시스템 변수를 통해 데드락 감시 스레드 작동을 제어할 수 있다. <br>
  `innodb_lock_wait_timeout` 시스템 변수를 통해 잠금 대기 시간을 설정할 수 있다.

<br>

### 버퍼 풀

- 디스크의 데이터 파일이나 인덱스 정보를 `메모리에 캐시`해 두는 공간이다.

- 쓰기 작업을 지연시켜 일괄 작업으로 처리할 수 있게 해주는 버퍼 역할이다. <br>
  → 랜덤한 디스크 작업의 횟수를 줄일 수 있다.

<br>

### 언두 로그(Undo-log)

- 트랜잭션 보장 <br>
  : 트랜잭션이 롤백될 때 언두 로그에 백업해둔 이전 버전의 데이터를 이용해 복구한다.

- 격리 수준 보장 <br>
  : 트랜잭션 격리 수준에 따라 데이터 조회 시 언두 로그에 백업해둔 데이터를 읽어 반환하기도 한다. <br>
  언두 로그는 이렇게 격리 수준을 유지하면서 `높은 동시성`을 제공한다.

- `INSERT` 문장으로 인한 언두 로그와 `UPDATE, DELETE` 문장으로 인한 언두 로그는 별도로 관리된다. <br>
  후자는 MVCC와 데이터 복구(롤백 포함)에 모두 사용되지만, 전자는 MVCC를 위해서는 사용되지 않는다.

- 언두 로그는 `언두 테이블스페이스(Undo Tablespace)`에 저장된다. <br>
  MySQL 8.0.14 버전 이후부터 시스템 테이블스페이스 외부의 별도 로그 파일에 기록한다.

<br>

### 체인지 버퍼

- 데이터가 `INSERT 혹은 UPDATE`되어 `인덱스`를 업데이트해야 할 때, <br>
  InnoDB는 변경해야 할 인덱스 페이지가 버퍼 풀에 있으면 바로 업데이트를 수행하지만, <br>
  그렇지 않으면 `체인지 버퍼`에 임시로 저장해 두고 바로 사용자에게 결과를 반환한다.

- 유니크 인덱스는 중복 여부를 체크하고 결과를 전달해야 하므로 체인지 버퍼를 사용할 수 없다.

<br>

### 리두 로그 및 로그 버퍼

- `리두 로그(Redo Log)`는 서버가 비정상적으로 종료되었을 때 데이터 파일에 기록되지 못한 데이터를 잃지 않게 해주는 안전장치다. <br>
  → 트랜잭션의 4가지 요소인 ACID 중에서 `D(Durable)`에 해당하는 `영속성`과 가장 연관되어 있다.

- 리두 로그는 쓰기 비용이 낮은 자료 구조로 되어 있어, 데이터 파일 쓰기가 발생할 때 디스크로 인한 성능 저하를 막아준다.

- `로그 버퍼 혹은 버퍼 풀` 은 리두 로그를 버퍼링할 수 있어, 성능 저하를 막아준다.
  
